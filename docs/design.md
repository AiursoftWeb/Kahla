# 卡拉全新架构方案

## 用户

用户，即为卡拉的用户。用户有以下属性：

* ID
* 昵称
* Email
* Bio
* 倾向的主题 ID
* 允许自己被硬拉入（默认允许）
  * 在界面上，这里展示为开关：“Private Account”，增加注释："Other users can't add you to a conversation. (You can still join a conversation by yourself)"
  * 在提交到API时，其值取反。
* 允许系统为自己发 Email （默认允许）
* 允许自己被通过昵称被搜索到（默认允许）
* 回车发送消息 （默认允许）
* 隐藏我的在线状态

## 对话

对话，也就是 Conversation。不区分私聊和群聊。对话里存在1-N个人。如果只剩0个人了，则删除这个对话。

### 属性列表

对话有以下属性：

* ID
* 对话名称（默认是 {THE OTHER USER}，只有管理员可以修改）
* 对话头像（默认是 {THE OTHER USER ICON}，只有管理员可以修改）
* 群主的“对话与人的关系”的ID
* 允许外部人员直接加入这个对话（默认不允许，指的是不通过软拉入，直接加入对话）
* 允许通过会话名称被搜索到（默认不允许）
* 允许成员发起软拉入（默认不允许）
* 允许成员发消息（默认允许）（如果把这个关了，就变成只有管理员可以发消息，就变成公众号了）
* 允许成员查看成员列表（默认允许，即使这个设置是关闭的，他也可以看到群主）

### 名称

所有Conversation都有名称属性。管理员可以重命名这个对话。

Conversation的名称默认是 {THE OTHER USER}。前端遇到这个默认值时：

* 如果只有一个人，展示为自己的名字。
* 如果只有两个人，展示为除了自己的那个人的名字。
* 如果不止两个人，展示为 Conversation with User1, User2, User3... (此时用户看到这个应该会想去重命名）

### 头像

所有Conversation都有头像属性。管理员可以重命名这个头像。

Conversation的头像默认是 {THE OTHER USER}。前端遇到这个默认值时：

* 如果只有一个人，展示自己的头像。
* 如果只有两个人，展示为除了自己的那个人的头像。
* 如果不止两个人，展示为九宫格。

服务器永远会返回给前端一个对话里，参加的前10个人的头像。这样，如果需要展示九宫格，即可消费这个字段。

### 管理方面

用户可以随意创建对话。有两种将其他用户拉入对话的方式。

### 硬拉入

硬拉入，允许用户直接创建一个只有自己和目标用户的对话。

额外开发卡拉防垃圾系统来防止滥用硬拉入功能。

被硬拉入后，发起人将成为群主。发起人是管理员。目标用户是管理员。

### 软拉入

软拉入，允许用户在一个已有对话中，拉入新的用户。

* 管理员随时可以发起软拉入。软拉入的用户将成为普通成员。
* 普调用户只可以在允许成员发起软拉入的对话中发起软拉入。软拉入的用户将成为普通成员。

这个时候需要服务器签发一个拉入邀请的token，将token发送给目标用户。目标用户点击这个token后，将自动加入这个对话。

token是一段字符串，由点分割，前半部分是一个 JSON，后半部分是前半部分的数字签名。

前半部分的 JSON 包含：

* 邀请这位用户加入的对话ID
* 这位用户的ID
* 过期时间
* Token的创建人ID（暂时没用）

自己也可以和自己对话（只有一个人的对话）

对话的管理方面，有下面几个 API：

* 转让群主 （只有群主有这个权限）
* 提拔管理员 （只有群主有这个权限）
* 降级管理员 （只有群主有这个权限）
* 修改对话名称 （只有管理员有这个权限）
* 修改对话头像 （只有管理员有这个权限）
* 修改对话设置 （五个布尔值）（只有管理员有这个权限）
* 禁言用户 （只有管理员有这个权限）

## 对话与人的关系

每个人想要加入一个对话，都需要在服务器上创建一个实体，也就是“对话与人的关系”。

这个实体包含：

* ID
* 对话ID
* 用户ID
* 加入时间
* Alias （用户给自己在这个对话里的别名）
* 权限（枚举类型，包含：管理员，成员）
* 是否静音 （默认不静音）
* 是否被禁言 （默认不被禁言）
* 阅读时间戳（用户最后一次阅读这个对话的时间）

对话与人关系的管理方面，有下面几个 API：

* 查看对话里的成员列表
* 静音、取消静音（只有自己有这个权限）
* 离开对话 （只有自己有这个权限）

## 黑名单记录

用户如果特别烦某个人，可以将其加入黑名单。加入黑名单后，对方将无法再和你对话。黑名单用户不会被展示在通讯录中。

黑名单单独在数据库的一个表中存储。包含：

* 所属用户ID
* 黑名单用户ID
* 创建时间
* 过期时间

Block 功能只影响硬拉入功能。在黑名单用户被 Block 期间，他无法硬拉入你的对话。Block 功能不影响发送消息功能。

为了避免用户在 Block 后仍然能收到消息，前端在调用完 Block API 后，应该立即将这个用户从所有 包含且仅包含自己和被 Block 的用户的对话 中离开。

## 通讯录

通讯录可以查看自己已知的用户。（不可以查看群聊）

通讯录包含的属性：

* ID
* 所属用户ID
* 目标用户ID
* 创建时间

通讯录可以随意增删改查。当然，这里也提供搜索功能，能将搜索结果加为好友。不需要任何审批。

如果在好友列表里，一个用户发现了一个好友，并选择和他对话，这个时候执行这段逻辑：

* 如果我们已经有一个私聊对话了，则直接去这个对话。
* 如果我们没有这个私聊对话，（这种情况下，可能是因为刚刚的私聊对话，被拉人了，升级成群聊了。）我再和你创建一个新对话。

在角落弄个隐藏的小按钮，叫 New Conversation。按下后，无论我们是否已经有一个对话了，都强行创建一个新对话。

在角落弄一个隐藏的小按钮，可以查看我们共同参与的 Conversation 列表。

## 消息

消息，即为 Message。消息有以下属性：

* ID
* 对话ID
* 发送者ID
* 发送时间
* 消息内容

# 卡拉防垃圾系统

如果用户:

* 在3分钟内使用了超过9次硬拉入功能
* 在3分钟内使用了超过30次发消息功能

那么这个用户将被系统自动标记为suspect。

Suspect 用户：

* 发送消息的频率将会被限制为一分钟5条
* 硬拉入功能将会被限制为一分钟最多1次

一个用户第一次被标记为 Suspect 后，其封禁时间为 2 天。第二次被标记为 Suspect 后，其封禁时间为 7 天。第三次被标记为 Suspect 后，其封禁时间为永久。

用户被永久封禁以后，将

* 无法使用硬拉入功能
* 无法发送消息

# 用例

## 创建群聊

用户在 App 里点击创建群聊按钮，这个时候他需要填写表单：

* 群聊名称
* 是否允许被搜索到
* 是否允许直接加入
* 是否允许群成员发起软拉入
* (无需询问：是否允许群成员发消息，默认允许)
* (无需询问：是否允许群成员查看成员列表，默认允许)

## 创建私聊

用户在 App 里通过昵称搜索到了一个用户，点击这个用户，即可看到一个按钮：“开始对话”。点击这个按钮时：

* 如果存在一个只有自己和目标用户的对话，直接进入这个对话。
* 如果不存在这个对话，创建一个新的对话。

用户在隐藏的角落里，可以查看和目标用户共同参与的对话列表。

用户在隐藏的角落里，可以点击“强制创建新对话”按钮，无论是否已经有对话，都创建一个新对话。

## 私聊原地升级为群聊

用户在一个私聊对话里，点击“拉入新用户”按钮，App 会询问用户想要拉入的用户是谁。用户可以在通讯录中选择一个用户，或者搜索一个用户。

选择后，执行软拉入逻辑。

软拉入以后，即可变成一个：

* 不允许直接加入
* 不允许被搜索到
* 允许群成员发起软拉入的群聊

## 加入不允许直接加入的群聊

用户在 App 里搜索到了一个群聊，点击这个群聊，即可看到一个按钮：“加入对话”。点击这个按钮时：

* 如果这个对话允许直接加入，直接加入这个对话。
* 如果这个对话不允许直接加入，App 会询问用户是否想要向群主申请，由群主软拉入。
  * 如果用户选择发起申请，App 自动以用户的名义，向群主发一条消息，请求加入这个对话。
  * 群主收到消息后，如果同意，则执行软拉入逻辑。向用户发送软拉入邀请。
  * 用户收到邀请后，点击邀请，即可加入这个对话。

## 无图可画

正常会话，服务器会返回给前端前10个人的头像。这样，如果会话的头像是'{THE OTHER USER}'，前端可以展示九宫格。

但是，如果这个会话：

* 禁止成员查看成员列表
* 用户尚未加入这个对话

这种情况下，显然不能返回前10个人的头像。这个时候，前端应当加载全服默认头像。

## 用户不想继续对话

用户在一个对话里，点击“离开对话”按钮，即可离开这个对话。

这时，对于 App 来说：

* 如果我就是这个对话的群主，显然我不能离开这个对话，
  * 如果对话里只有两个人，直接将群主转移给对方。然后离开这个对话。
  * 如果对话里有大于两个人，则必须提示用户：你是群主，你需要先转移群主身份，才能离开这个对话。
* 如果我不是这个对话的群主，那么我可以直接离开这个对话。

## 创建一个公众号

新建一个群聊，然后将设置改为：

* 允许外部人员直接加入这个对话
* 允许列举在搜索结果中
* 允许成员发起软拉入
* 不允许成员发消息
* 不允许成员查看成员列表

## 搜索我要对话的人

用户在 App 里搜索一个昵称，是一个字符串。

这里为了搜索到群，需要在搜索结果中包含群。

这里为了搜索到用户，需要在搜索结果中包含用户。

## 将对话的对方保存到通讯录

在对话过程中，用户可以随时查看这个对话列表中的每一个用户，并直接一键将其添加到自己的通讯录中。

只要没有添加对方就可以添加。没有审批系统。
